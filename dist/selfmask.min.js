var SelfmaskPluginManager;$(function(){function t(t,n){this.x=t||0,this.y=n||0}function n(n,o,e){return new t(Math.sin(e*Math.PI*2)*o+n.x,Math.cos(e*Math.PI*2)*o+n.y)}function o(t,n){return t&&("both"==n||"std"==n)||!t&&("both"==n||"own"==n)}function e(){for(var t=decodeURIComponent(window.location.hash.substring(1)),n=t.split("&"),o={populationsCount:0,populationsNames:[],masks:{selfmasks:{},othermasks:{}}},e={},s=0;s<n.length;s++){var i=n[s].split("=");if(2!=i.length)return;e[i[0]]=i[1]}if("pc"in e&&!isNaN(e.pc)){o.populationsCount=e.pc;for(var s=0;s<o.populationsCount;s++){if(!("n"+s in e))return;if(o.populationsNames.push(e["n"+s]),!("s"+(s+1)in e)||isNaN(e["s"+(s+1)]))return;if(o.masks.selfmasks[s+1]=e["s"+(s+1)],!("o"+(s+1)in e)||isNaN(e["o"+(s+1)]))return;o.masks.othermasks[s+1]=e["o"+(s+1)]}return o}}function s(t,n,o){for(var e="pc="+t,s=0;t>s;s++)e=e.concat("&n"+s+"="+n[s]);for(var s=0;t>s;s++)e=e.concat("&s"+(s+1)+"="+o.selfmasks[s+1]),e=e.concat("&o"+(s+1)+"="+o.othermasks[s+1]);window.location.hash=encodeURIComponent(e)}function i(){this.canvas=document.getElementById("network-graph"),this.context=this.canvas.getContext("2d"),this.zoomingFactor=2.223277,this.dashedColor="#c00",this.dashedLineWidth=2.5*this.zoomingFactor,this.dashedLineLength=10,this.waveColor="#aaa",this.waveLineLength=15,this.waveLineWidth=3*this.zoomingFactor}function a(){}function r(){this.options=[$('<option value="none">None</option>'),$('<option value="std" class="connection-std">Standard</option>'),$('<option value="own" class="connection-own">Custom</option>'),$('<option value="both" class="connection-both">Both</option>')],this.checkboxes=[["Standard","S",$('<input type="checkbox" name="std" class="connection std"/>')],["Custom","C",$('<input type="checkbox" name="own" class="connection own"/>')]]}function c(){this.autocorrect=!0}t.prototype.x=null,t.prototype.y=null,t.prototype.add=function(n,o){return n instanceof t?new t(this.x+n.x,this.y+n.y):new t(this.x+n,this.y+o)},t.prototype.offset=function(t){this.x+=t.x,this.y+=t.y},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.normalizedVector=function(n){var o=n.x-this.x,e=n.y-this.y,s=this.distance(n);return new t(o/s,e/s)},t.prototype.leftOrtogonal=function(){return new t(this.y,-this.x)},t.prototype.distance=function(t){var n=this.x-t.x,o=this.y-t.y;return Math.sqrt(n*n+o*o)},t.prototype.multiply=function(n){return new t(this.x*n,this.y*n)},i.prototype.resize=function(){this.canvas.style.width="100%",this.canvas.style.height="400pt",this.canvas.width=this.canvas.offsetWidth*this.zoomingFactor,this.canvas.height=this.canvas.offsetHeight*this.zoomingFactor},i.prototype.getSize=function(){return Math.min(this.canvas.height,this.canvas.width)},i.prototype.getOffset=function(){var n=this.getSize();return new t((this.canvas.width-n)/2,(this.canvas.height-n)/2)},i.prototype.getNodeRadius=function(){return.075*this.getSize()},i.prototype.getPositions=function(n){for(var o=this.getOffset(),e=this.getSize(),s={2:[new t(.25*e,.5*e),new t(.75*e,.5*e)],3:[new t(.5*e,.2835*e),new t(.25*e,.7165*e),new t(.75*e,.7165*e)],4:[new t(.25*e,.25*e),new t(.75*e,.25*e),new t(.25*e,.75*e),new t(.75*e,.75*e)]}[n],i=0;n>i;i++)s[i].offset(o);return s},i.prototype.drawDashedLine=function(t,n){this.context.strokeStyle=this.dashedColor,this.context.lineWidth=this.dashedLineWidth;for(var o=t.normalizedVector(n).multiply(this.dashedLineLength),e=t.clone(),s=t.distance(n);t.distance(e)<s;)this.context.beginPath(),this.context.moveTo(e.x,e.y),e.offset(o),this.context.lineTo(e.x,e.y),this.context.stroke(),e.offset(o)},i.prototype.drawDashedCircle=function(t,o){this.context.strokeStyle=this.dashedColor,this.context.lineWidth=this.dashedLineWidth;for(var e=this.dashedLineLength/(2*Math.PI*o),s=0;1>s;){this.context.beginPath();var i=n(t,o,s);this.context.moveTo(i.x,i.y),s+=e,i=n(t,o,s),this.context.lineTo(i.x,i.y),this.context.stroke(),s+=e}},i.prototype.drawWaveLine=function(t,n){this.context.strokeStyle=this.waveColor,this.context.lineWidth=this.waveLineWidth;var o=t.normalizedVector(n).multiply(this.waveLineLength),e=o.leftOrtogonal().multiply(2),s=t.add(e.multiply(-1)).add(o),i=t.clone();e=t.add(e).add(o);var a=t.distance(n);o=o.multiply(2);var r=o.multiply(2);for(s.offset(o);t.distance(i)<a;)this.context.beginPath(),this.context.moveTo(i.x,i.y),i.offset(o),this.context.quadraticCurveTo(e.x,e.y,i.x,i.y),e.offset(r),i.offset(o),this.context.quadraticCurveTo(s.x,s.y,i.x,i.y),s.offset(r),this.context.stroke()},i.prototype.drawWaveCircle=function(t,o){this.context.strokeStyle=this.waveColor,this.context.lineWidth=this.waveLineWidth;for(var e=this.waveLineLength/(2*Math.PI*o)*.9,s=0;1>s;){this.context.beginPath();var i=n(t,o,s);s+=e;var a=n(t,o+1.5*this.waveLineLength,s);s+=e;var r=n(t,o,s);this.context.moveTo(i.x,i.y),this.context.quadraticCurveTo(a.x,a.y,r.x,r.y),s+=e,a=n(t,o-1.5*this.waveLineLength,s),s+=e,r=n(t,o,s),this.context.quadraticCurveTo(a.x,a.y,r.x,r.y),this.context.stroke()}},i.prototype.drawNode=function(t,n){this.context.fillStyle="#999",this.context.beginPath(),this.context.arc(t.x,t.y,this.getNodeRadius(),0,2*Math.PI,!1),this.context.closePath(),this.context.fill(),this.context.fillStyle="#fff",this.context.font="bold 36px sans-serif",this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillText(n,t.x,t.y)},i.prototype.drawNodes=function(t,n,o){for(var e=0;t>e;e++)this.drawNode(o[e],n[e])},i.prototype.drawConnections=function(t,n){for(var o in t)for(var e in t[o]){var s=n[o-1].add(.8*-this.getNodeRadius(),.8*-this.getNodeRadius()),i=.8*this.getNodeRadius();("both"==t[o][e]||"own"==t[o][e])&&(e==o?this.drawDashedCircle(s,i):this.drawDashedLine(n[o-1],n[e-1])),("both"==t[o][e]||"std"==t[o][e])&&(e==o?this.drawWaveCircle(s,i):this.drawWaveLine(n[o-1],n[e-1]))}},i.prototype.rebuild=function(t,n,o){this.resize();var e=this.getPositions(t);this.drawConnections(o,e),this.drawNodes(t,n,e)},a.prototype.buildHeader=function(t,n,o){var e=$('<table class="table"/>');t.empty().append(e);for(var s=$("<tr><td/></tr>"),i=0;n>i;++i)s.append($("<td/>",{text:o[i]}));return e.append(s),e},r.prototype=new a,r.prototype.buildForm=function(t,n){for(var o=this.buildHeader($("#combobox-panel"),t,n),e=0;t>e;++e){for(var s=$("<tr/>").append($("<td/>",{text:n[e]})),i=0;t>i;++i){var a=$("<td/>");if(i>=e)for(var r=0;r<this.checkboxes.length;r++){var c=this.checkboxes[r],h=c[2].clone().data("first",e+1).data("second",i+1).change($.proxy(this.checkboxChanged,this)),l=$('<span class="grid-cell '+c[1]+'" title="'+c[0]+'"><label>'+c[1]+"</label></span>");l.append(h),a.append(l)}s.append(a)}o.append(s)}},r.prototype.checkboxChanged=function(){var t={};$(":checkbox.connection").each(function(n,o){var e=$(o),s=e.data("first"),i=e.data("second"),o=e.hasClass("std")?"std":"own";e.prop("checked")&&(s in t||(t[s]={}),t[s][i]=i in t[s]?"both":o)}),SelfmaskPluginManager.setConnections(t)},r.prototype.fillForm=function(t,n){$(":checkbox.connection").each(function(t,e){var s=$(e),i=s.data("first"),a=s.data("second");i in n&&a in n[i]&&s.prop("checked",o(s.hasClass("std"),n[i][a]))})},r.prototype.rebuild=function(t,n,o){this.buildForm(t,n),this.fillForm(t,o)},c.prototype=new a,c.prototype.buildForm=function(t,n){function o(n){for(var o=$("<tr/>").append($("<td/>",{text:n})),e=1;t>=e;++e)o.append($("<td/>").append($('<input class="form-control input-small hexes" type="text"/>').data("number",e).data("rowName",n).change($.proxy(this.inputValueChanged,this))));return o}var e=this.buildHeader($("#hexes-panel"),t,n);e.append(o.call(this,"Selfmask")),e.append(o.call(this,"Othermask"))},c.prototype.validate=function(){this.clearValidation();var t=!0,n=new RegExp("^(0x){0,1}([A-Fa-f0-9]{1,8})$");return $("input.hexes").each(function(o,e){var s=$(e),i=parseInt(s.val(),16);(!n.test(s.val())||isNaN(i))&&(t=!1,s.parent().addClass("has-error"))}),t},c.prototype.clearValidation=function(){$("input.hexes").parent().removeClass("has-error")},c.prototype.getConnections=function(){var t={selfmasks:{},othermasks:{}},n=this.validate();if($("input.hexes").each(function(n,o){var e=$(o),s=e.data("number"),i=e.data("rowName"),a=parseInt(e.val(),16);t["Othermask"==i?"othermasks":"selfmasks"][s]=a}),n){var o=SelfmaskPluginManager.masksToConnections(t,SelfmaskPluginManager.populationsCount);return o}return null},c.prototype.inputValueChanged=function(){if(this.autocorrect){var t=this.getConnections();null==t?(this.fillForm(SelfmaskPluginManager.populationsCount,SelfmaskPluginManager.connections),this.clearValidation()):SelfmaskPluginManager.setConnections(t)}},c.prototype.fillForm=function(t,n){var o=SelfmaskPluginManager.connectionsToMasks(n,t);$("input.hexes").each(function(t,n){var e=$(n),s=e.data("number");"Othermask"==e.data("rowName")?e.val(SelfmaskPluginManager.intToHex(o.othermasks[s])):"Selfmask"==e.data("rowName")&&e.val(SelfmaskPluginManager.intToHex(o.selfmasks[s]))})},c.prototype.rebuild=function(t,n,o){console.log("Hexes plugin"),this.buildForm(t,n),this.fillForm(t,o)},SelfmaskPluginManager={names:[],populationsCount:4,connections:{1:{2:"own"},2:{2:"std",3:"std"},3:{4:"both"}},plugins:[new r,new c,new i],connectionToMask:function(t,n){var o=t-1,e=1<<o;return"both"==n?e=e<<16|e:"own"==n?e<<=16:"none"==n&&(e=0),e},maskToConnection:function(t,n){var o=65535,e=o<<16,s=t&n&e,i=t&n&o;return s&&i?"both":s?"own":i?"std":"none"},joinTwoConnections:function(t,n){return"both"==t||"both"==n?"both":"own"==t&&"std"==n||"std"==t&&"own"==n?"both":"own"==t||"own"==n?"own":"std"==t||"std"==n?"std":"none"},connectionsToMasks:function(t,n){for(var o={selfmasks:{},othermasks:{}},e=1;n>=e;++e)o.selfmasks[e]=this.connectionToMask(e,"both"),o.othermasks[e]=0;for(var s in t){var i=parseInt(s);if(!isNaN(i))for(var a in t[s]){var r=parseInt(a);isNaN(r)||(o.othermasks[s]|=this.connectionToMask(r,t[s][a]),o.othermasks[a]|=this.connectionToMask(i,t[s][a]))}}return o},masksToConnections:function(t,n){for(var o={},e=1;n>=e;++e){for(var s={},i=e;n>=i;++i){var a=this.joinTwoConnections(this.maskToConnection(t.selfmasks[e],t.othermasks[i]),this.maskToConnection(t.selfmasks[i],t.othermasks[e]));"none"!=a&&(s[i]=a)}$.isEmptyObject(s)||(o[e]=s)}return o},connectionToName:function(t){return"both"==t?"Both":"own"==t?"Custom":"std"==t?"Standard":"None"},resetInputNamesValues:function(){var t=this.names;$(".name-input").each(function(){var n=$(this),o=n.data("number");n.val(t[o-1])})},rebuildNamesPanel:function(){var t=$("#populations-names-panel");t.empty();for(var n=1;n<=this.populationsCount;++n){var o=$('<div class="col-md-3"/>'),e=$('<input type="text" class="form-control input-sm name-input"/>');e.data("number",n),o.append(e),t.append(o)}this.resetInputNamesValues(),$(".name-input").change($.proxy(SelfmaskPluginManager.namesChanged,SelfmaskPluginManager))},rebuild:function(){s(this.populationsCount,this.names,this.connectionsToMasks(this.connections,this.populationsCount)),this.rebuildNamesPanel(),this.plugins.forEach(function(t){console.log("initializing plugin: ",t),t.rebuild(this.populationsCount,this.names,this.connections)},this)},namesChanged:function(){if($(".name-input").is(function(){return""==$(this).val()}))resetInputNamesValues();else{var t=[];$(".name-input").each(function(){t[$(this).data("number")-1]=$(this).val()}),this.names=t,this.rebuild()}},setConnections:function(t){this.connections=t,this.rebuild()},trimConnections:function(){var t={};for(var n in this.connections)if(n<=this.populationsCount){var o={};for(var e in this.connections[n])e<=this.populationsCount&&(o[e]=this.connections[n][e]);$.isEmptyObject(o)||(t[n]=o)}this.connections=t},setPopulationsCount:function(t){this.populationsCount=parseInt(t),this.trimConnections(),this.rebuild()},getFramScript:function(){for(var t="",n=this.connectionsToMasks(this.connections,this.populationsCount),o=0;o<this.populationsCount;o++)t+="Population["+o+'].name="'+this.names[o]+'";\n',t+="Population["+o+"].selfmask="+this.intToHex(n.selfmasks[o+1])+";\n",t+="Population["+o+"].othermask="+this.intToHex(n.othermasks[o+1])+";\n";return t},editMasksMode:function(){$("select").add("input").add("checkbox").add("button").not("#save-masks-button").not("#cancel-masks-button").not("input.hexes").prop("disabled",!0),this.plugins[1].autocorrect=!1,$("#edit-masks-button").add("#save-cancel-masks-panel").toggleClass("hidden")},exitMasksMode:function(){this.plugins[1].autocorrect=!0,this.rebuild(),$("select").add("input").add("checkbox").add("button").prop("disabled",!1),$("#edit-masks-button").add("#save-cancel-masks-panel").toggleClass("hidden")},saveEditedMasks:function(){var t=this.plugins[1].getConnections();null!=t&&(this.setConnections(t),this.exitMasksMode())},intToHex:function(t){return"0x"+("00000000"+t.toString(16)).substr(-8)},connectionToColor:function(t){return{both:"#2196F3",own:"#8BC34A",std:"#FF9800",none:"gray"}[t]},init:function(){var t=e();null!=t&&(this.populationsCount=t.populationsCount,this.names=t.populationsNames,this.connections=this.masksToConnections(t.masks,this.populationsCount));for(var n=this.names.length+1;4>=n;n++)this.names.push("Pop "+n);$("#populations-count-select").val(this.populationsCount),this.rebuild()}},SelfmaskPluginManager.init(),$("#populations-count-select").change(function(){SelfmaskPluginManager.setPopulationsCount($(this).val())}),$("#framscript-button").click(function(){window.prompt("Copy to clipboard: Ctrl+C (⌘C), Enter",SelfmaskPluginManager.getFramScript())}),$("#edit-masks-button").click(function(){SelfmaskPluginManager.editMasksMode()}),$("#cancel-masks-button").click(function(){SelfmaskPluginManager.exitMasksMode()}),$("#save-masks-button").click(function(){SelfmaskPluginManager.saveEditedMasks()}),$(window).resize(function(){SelfmaskPluginManager.rebuild()})});